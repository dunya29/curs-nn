<script src="https://api-maps.yandex.ru/2.1/?apikey=d02ef18b-3f8a-40d8-ad6a-d6aad95f6099&lang=ru_RU"></script>
<script>
    let gto = [
        {
            id: 1,
            coords: [56.269911, 43.883205]
        },
        {
            id: 2,
            coords: [56.269096, 43.881327]
        },
        {
            id: 3,
            coords: [56.271660, 43.883609]
        },
        {
            id: 4,
            coords: [56.269051, 43.888217]
        }
    ]
</script>
<script>
    const gtoScroll = document.querySelector(".po-gto__list .custom-scroll")
    const gtoListTab = document.querySelector("[data-tab='po-gto-list']")
    const gtoItems = document.querySelectorAll("[data-gto-id]")
    const gtoModal =  document.querySelector("#gto-modal")
    const gtoSearch =  document.querySelector(".gto-search")
    let center = [56.326797, 44.006516];  
    let gtoMap
    let geoObjects = [] 
    let activePlacemark 
    let gtoTimeout
    let maxZoom = 15
    function setmapDefaults(map) {
        map.controls.remove('rulerControl');
        map.margin.setDefaultMargin(100);
    }   
    function placemarkOnClick(gtoId) {
        clearTimeout(gtoTimeout)
        const gtoItem = document.querySelector(`[data-gto-id='${gtoId}']`)
        if (gtoScroll && gtoItem) {
            gtoItem.click()
            if (gtoListTab) {
                gtoListTab.click()
            }
            gtoTimeout = setTimeout(() => {                 
                let scrollDiff = gtoItem.getBoundingClientRect().top - gtoScroll.getBoundingClientRect().top ;
                gtoScroll.scrollTop = parseInt(gtoScroll.scrollTop + scrollDiff )
            }, 600) 
        }        
    } 
    function resetActive() {
        gtoItems.forEach(item => item.classList.remove("active"))
        geoObjects.forEach(item => {
            item.options.set({
                iconImageHref: 'img/svg/map-mark.svg',
                iconImageSize: [22, 28],
                iconImageOffset: [-14, -14],
            }) 
        })
    }
    function gtoMapInit() {
        gtoMap = new ymaps.Map('gto-map', {
            center: center,
            zoom: 6
        });
        setmapDefaults(gtoMap) 
        gto.forEach((item,i) => {
            geoObjects[i] = new ymaps.Placemark(item.coords, 
                {}, 
                {
                    iconLayout: "default#image",
                    iconImageHref: "img/svg/map-mark.svg",
                    iconImageSize: [22, 28],
                    iconImageOffset: [-14, -14],
                    cursor: "pointer",
                }
            )
            geoObjects[i].events.add('click', e => {
                e.preventDefault()
                placemarkOnClick(gto[i]['id'])
            });

        })
        geoObjects.forEach(item => gtoMap.geoObjects.add(item))
        gtoMap.setBounds(gtoMap.geoObjects.getBounds(), {checkZoomRange: true, zoomMargin: 100})
        if (gtoItems.length) {
            gtoItems.forEach(item => {
                item.addEventListener("click", e => {
                    let id = Number(item.getAttribute("data-gto-id"))
                    let idx = gto.findIndex(item => Number(item.id) === id)
                    if (geoObjects[idx]) {
                        if(!item.classList.contains("active")) {
                            resetActive()
                            item.classList.add("active")
                            const coords = geoObjects[idx].geometry.getCoordinates(); 
                            gtoMap.setCenter(coords, maxZoom);
                            geoObjects[idx].options.set({
                                iconImageHref: 'img/svg/map-mark-active.svg',
                                iconImageSize: [32, 40],
                                iconImageOffset: [-16, -20],
                            })
                        } else {
                            resetActive()
                        }                  
                    }   
                }) 
            })            
            if (gtoSearch) {
                gtoSearch.querySelector("input").addEventListener("input", e => {
                    let shownObjects,
                        bySearch = new ymaps.GeoQueryResult();
                    gtoItems.forEach(item => {
                        let id = Number(item.getAttribute("data-gto-id"))
                        let idx = gto.findIndex(item => Number(item.id) === id)
                        let find = item.querySelector(".item-gto__title").textContent.toLowerCase().includes(e.target.value.toLowerCase())
                        if (!find) {
                            item.classList.add("hide")
                            geoObjects[idx].options.set('visible', false);
                        } else {
                            item.classList.remove("hide")
                            geoObjects[idx].options.set('visible', true);
                        }
                    })
                })
                gtoSearch.addEventListener("reset", () => {
                    gtoItems.forEach(item => item.classList.remove('hide'))
                    geoObjects.forEach(item => item.options.set('visible', true))
                })
            }
        }
        const points = [
            { coords: [56.317110, 43.941928], name: 'Остановка 1' },
    { coords: [56.280787, 43.937892], name: 'Остановка 2' },
    { coords: [56.300982, 43.940035 ], name: 'Остановка 3' },
];
function buildRoute(points) {
        if (!gtoMap) {
            console.error('Карта не инициализирована');
            return;
        }
        // Создаем маршрут через все точки
        let route = new ymaps.multiRouter.MultiRoute({
                referencePoints: points.map(point => point.coords),
                params: {
                    routingMode: 'masstransit', // Режим маршрутизации - общественный транспорт
        results: 1, // Количество вариантов маршрута
        routingTypes: { // Конкретные виды транспорта
            tram: true, // ВКЛЮЧАЕМ трамвай
            bus: false, // отключаем автобус
            trolleybus: false, // отключаем троллейбус
            subway: false, // отключаем метро
            pedestrian: false // отключаем пешеходные участки
        }
                }
            }, {
                viaPointColor: '#FFFFFF',
    viaPointActiveRadius: 0,
    pinVisible: false,
    wayPointVisible: false,
    boundsViaPointBalloon: false,
   // viaPointBalloonVisible: false,
    wayPointBalloonVisible: false,
    routeActivePedestrianIconVisible: false,
    routeActiveMarkerVisible: false,
    
    // Стиль линии
    routeActiveStrokeWidth: 5,
    routeActiveStrokeColor: '#1e98ff',
    routeActiveStrokeStyle: 'solid',

                // Отключаем все стандартные метки
                wayPointVisible: false,
                viaPointVisible: false,
                pinVisible: false,
                
                // Настраиваем внешний вид маршрута
                routeActiveStrokeWidth: 4,
                routeActiveStrokeStyle: 'solid',
                routeActiveStrokeColor: '#000',
                
                // Отключаем балуны при клике на маршрут
                routeOpenBalloonOnClick: false,
                
                // Настраиваем метки точек (делаем невидимыми)
                wayPointStartIconColor: 'transparent',
                wayPointStartIconFillColor: 'transparent',
                wayPointStartIconStrokeColor: 'transparent',
                
                wayPointEndIconColor: 'transparent',
                wayPointEndIconFillColor: 'transparent',
                wayPointEndIconStrokeColor: 'transparent',
                
                viaPointIconColor: 'transparent',
                viaPointIconFillColor: 'transparent',
                viaPointIconStrokeColor: 'transparent',
                
                // Отключаем хинты при наведении на маршрут
                routeHideIconOnBalloonOpen: false
            }
        );

        // Дополнительно: отключаем балуны для всех геообъектов маршрута
        route.events.add('click', function(e) {
            e.preventDefault();
            alert("Клик")
        });
        
        gtoMap.geoObjects.add(route);
    }
    buildRoute(points);
    function addPlacemarks(points, names = []) {
        points.forEach((point, index) => {
            const placemark = new ymaps.Placemark(point, {
                balloonContent: names[index] || `Точка ${index + 1}`
            });
            gtoMap.geoObjects.add(placemark);
        });
    }
    const createCustomPlacemark = (point, name, color = '#1e98ff') => {
  return new ymaps.Placemark(
    point,
    {
      hintContent: name,
      balloonContent: name
    },
    {
      iconLayout: 'default#imageWithContent',
      iconImageHref: 'https://cdn-icons-png.flaticon.com/512/75/75293.png', // ваша иконка
      iconImageSize: [20, 20],
      iconImageOffset: [-10, -20],
      
      // Настройки для текста
      iconContentLayout: ymaps.templateLayoutFactory.createClass(
        '<div style="color: #ffffff; font-weight: bold; font-size: 12px; text-shadow: 0 0 2px #000;">{{ properties.iconContent }}</div>'
      ),
      iconContentOffset: [0, 10],
      iconContent: name.substring(0, 3) // первые 3 буквы названия
    }
  );
};
  const placemarks = points.map(point => 
    createCustomPlacemark(point.coords, point.name)
  );

  // Добавляем метки на карту
  placemarks.forEach(placemark => gtoMap.geoObjects.add(placemark));
//addPlacemarks(points, pointNames);



// Координаты для первой полилинии (синяя)
        var polyline1Points = [
            [56.326887, 44.005986],  // Центр города
            [56.312, 44.048],        // Московский вокзал
            [56.294, 44.054],        // Площадь Ленина
            [56.270, 44.037]         // Сенная площадь
        ];

        // Координаты для второй полилинии (красная)
        var polyline2Points = [
            [56.326887, 44.005986],  // Центр города
            [56.320, 43.945],        // Канавинский мост
            [56.335, 43.890],        // Сортировочная
            [56.350, 43.840]         // Дубравная
        ];


        // Создаем первую полилинию (синяя)
            var polyline1 = new ymaps.Polyline(polyline1Points, {}, {
                strokeColor: '#0000FF',
                strokeWidth: 5,
                strokeOpacity: 0.7
            });

            // Создаем вторую полилинию (красная)
            var polyline2 = new ymaps.Polyline(polyline2Points, {}, {
                strokeColor: '#FF0000',
                strokeWidth: 5,
                strokeOpacity: 0.7
            });

            // Добавляем линии на карту
            gtoMap.geoObjects.add(polyline1);
            gtoMap.geoObjects.add(polyline2);

       /*  // Добавляем точки (некликабельные)
            polyline1Points.forEach(function(point, index) {
                var placemark = new ymaps.Placemark(point, {}, {
                    preset: 'islands#circleIcon',
                    iconColor: '#0000FF',
                    hasBalloon: false,
                    hasHint: false,
                    interactivityModel: 'default#silent' // Делаем некликабельным
                });
                gtoMap.geoObjects.add(placemark);
            });
*/
            polyline2Points.forEach(function(point, index) {
                var placemark = new ymaps.Placemark(point, {}, {
                    preset: 'islands#circleIcon',
                    iconColor: '#FF0000',
                    hasBalloon: false,
                    hasHint: false,
                    interactivityModel: 'default#silent' // Делаем некликабельным
                });
                gtoMap.geoObjects.add(placemark);
            }); 
// Обработчики клика на линии
            polyline1.events.add('click', function(e) {
                alert('Клик по синей линии!');
            });

            polyline2.events.add('click', function(e) {
                alert('Клик по красной линии!');
            });

            // Автоматическое масштабирование карты чтобы показать все полилинии
            gtoMap.setBounds(gtoMap.geoObjects.getBounds(), {
                checkZoomRange: true
            });

    }  
    if (gto.length && document.querySelector("#gto-map")) {
        ymaps.ready(gtoMapInit);
    }
</script>